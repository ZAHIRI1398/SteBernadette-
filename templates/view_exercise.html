{% extends "base.html" %}

{% block title %}{{ exercise.title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{{ exercise.title }}</h2>
        <div>
            {% if current_user.is_teacher %}
                <a href="{{ url_for('edit_exercise', exercise_id=exercise.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                {% if exercise.teacher_id == current_user.id %}
                    <a href="{{ url_for('exercise_stats', exercise_id=exercise.id) }}" class="btn btn-info ms-2">
                        <i class="fas fa-chart-bar"></i> Statistiques
                    </a>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if current_user.is_teacher %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">Mode enseignant - Aper√ßu de l'exercice</h5>
            </div>
            <div class="card-body">
                {% if exercise.exercise_type == 'qcm' %}
                    {% include 'exercise_types/qcm_preview.html' %}
                {% elif exercise.exercise_type == 'word_search' %}
                    {% include 'exercise_types/word_search_preview.html' %}
                {% elif exercise.exercise_type == 'drag_and_drop' %}
                    {% include 'exercise_types/drag_and_drop_preview.html' %}
                {% elif exercise.exercise_type == 'fill_in_blanks' %}
                    {% include 'exercise_types/fill_in_blanks_preview.html' %}
                {% elif exercise.exercise_type == 'pairs' %}
                    {% include 'exercise_types/pairs_preview.html' %}
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="exercise-container">
            {% if exercise.exercise_type == 'qcm' %}
                {% include 'exercise_types/qcm_preview.html' %}
            {% elif exercise.exercise_type == 'word_search' %}
                {% include 'exercise_types/word_search_preview.html' %}
            {% elif exercise.exercise_type == 'drag_and_drop' %}
                {% include 'exercise_types/drag_and_drop_preview.html' %}
            {% elif exercise.exercise_type == 'fill_in_blanks' %}
                {% include 'exercise_types/fill_in_blanks_preview.html' %}
            {% elif exercise.exercise_type == 'pairs' %}
                {% include 'exercise_types/pairs_preview.html' %}
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const exerciseType = '{{ exercise.exercise_type }}';
    const exerciseContent = {{ exercise.get_content()|tojson|safe }};
    const form = document.getElementById('exerciseForm');
    const answersContainer = document.getElementById('answersContainer');
    
    function handleQCM() {
        if (!exerciseContent.questions) return;
        
        exerciseContent.questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'mb-3';
            questionDiv.innerHTML = `
                <input type="hidden" name="question_${index}" value="${question.question}">
                <div class="form-group">
                    <label class="form-label">${question.question}</label>
                    ${question.options.map(option => `
                        <div class="form-check">
                            <input class="form-check-input" type="radio" 
                                   name="answer_${index}" value="${option}" required>
                            <label class="form-check-label">${option}</label>
                        </div>
                    `).join('')}
                </div>
            `;
            answersContainer.appendChild(questionDiv);
        });
    }

    function handleWordSearch() {
        const selectedWords = new Set();
        const gridContainer = document.querySelector('.word-search-grid');
        
        if (!gridContainer) return;
        
        let isSelecting = false;
        let startCell = null;
        let currentSelection = [];
        
        function highlightCell(cell) {
            cell.classList.add('selected');
        }

        function clearSelection() {
            currentSelection.forEach(cell => cell.classList.remove('selected'));
            currentSelection = [];
        }

        function isValidSelection(start, end) {
            const startRow = parseInt(start.dataset.row, 10);
            const startCol = parseInt(start.dataset.col, 10);
            const endRow = parseInt(end.dataset.row, 10);
            const endCol = parseInt(end.dataset.col, 10);
            
            return startRow === endRow || // Horizontale
                   startCol === endCol || // Verticale
                   Math.abs(endRow - startRow) === Math.abs(endCol - startCol); // Diagonale
        }

        function updateSelection(start, end) {
            const cells = getCellsBetween(start, end);
            cells.forEach(highlightCell);
            currentSelection = cells;
        }

        function getCellsBetween(start, end) {
            const cells = [];
            const startRow = parseInt(start.dataset.row, 10);
            const startCol = parseInt(start.dataset.col, 10);
            const endRow = parseInt(end.dataset.row, 10);
            const endCol = parseInt(end.dataset.col, 10);
            
            const rowDir = Math.sign(endRow - startRow) || 0;
            const colDir = Math.sign(endCol - startCol) || 0;
            
            let currentRow = startRow;
            let currentCol = startCol;
            
            while (true) {
                const cell = document.querySelector(`.grid-cell[data-row="${currentRow}"][data-col="${currentCol}"]`);
                if (cell) cells.push(cell);
                
                if (currentRow === endRow && currentCol === endCol) break;
                
                currentRow += rowDir;
                currentCol += colDir;
            }
            
            return cells;
        }

        function getSelectedWord() {
            return currentSelection
                .map(cell => cell.textContent.trim())
                .join('');
        }

        function markWordAsFound(wordElement) {
            wordElement.classList.add('found');
        }

        function updateAnswers() {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'found_words';
            input.value = JSON.stringify(Array.from(selectedWords));
            
            const oldInput = form.querySelector('input[name="found_words"]');
            if (oldInput) {
                oldInput.remove();
            }
            form.appendChild(input);
        }

        gridContainer.addEventListener('mousedown', function(e) {
            const cell = e.target.closest('.grid-cell');
            if (cell) {
                isSelecting = true;
                startCell = cell;
                currentSelection = [cell];
                highlightCell(cell);
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (!isSelecting) return;
            
            const cell = e.target.closest('.grid-cell');
            if (cell && cell !== currentSelection[currentSelection.length - 1]) {
                if (isValidSelection(startCell, cell)) {
                    clearSelection();
                    updateSelection(startCell, cell);
                }
            }
        });

        document.addEventListener('mouseup', function() {
            if (isSelecting) {
                isSelecting = false;
                const selectedWord = getSelectedWord();
                if (selectedWord) {
                    const wordElements = document.querySelectorAll('.word-list li');
                    wordElements.forEach(el => {
                        if (el.dataset.word === selectedWord) {
                            selectedWords.add(selectedWord);
                            markWordAsFound(el);
                            updateAnswers();
                        }
                    });
                }
                clearSelection();
            }
        });
    }

    function handleDragAndDrop() {
        const draggables = document.querySelectorAll('.draggable');
        const dropZones = document.querySelectorAll('.drop-zone');
        let draggedItem = null;

        function updateDragDropAnswers() {
            const answers = {};
            dropZones.forEach(zone => {
                const zoneId = zone.dataset.zone;
                const item = zone.querySelector('.draggable');
                if (item) {
                    answers[zoneId] = item.dataset.value;
                }
            });
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'answers';
            input.value = JSON.stringify(answers);
            
            const oldInput = form.querySelector('input[name="answers"]');
            if (oldInput) {
                oldInput.remove();
            }
            form.appendChild(input);
        }

        draggables.forEach(draggable => {
            draggable.addEventListener('dragstart', function() {
                draggedItem = this;
                setTimeout(() => this.classList.add('dragging'), 0);
            });

            draggable.addEventListener('dragend', function() {
                this.classList.remove('dragging');
            });
        });

        dropZones.forEach(zone => {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });

            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                
                if (draggedItem) {
                    const clone = draggedItem.cloneNode(true);
                    const zoneContent = this.querySelector('.zone-content');
                    if (zoneContent) {
                        zoneContent.innerHTML = '';
                        zoneContent.appendChild(clone);
                    }
                    draggedItem.remove();
                    this.classList.add('has-item');
                    updateDragDropAnswers();
                }
            });
        });
    }

    function handleFillInBlanks() {
        const blanks = document.querySelectorAll('.blank');
        const answers = {};

        blanks.forEach(blank => {
            const input = document.createElement('input');
            input.type = 'text';
            input.name = `answer_${blank.dataset.index}`;
            input.required = true;
            blank.appendChild(input);

            input.addEventListener('input', function() {
                answers[blank.dataset.index] = this.value;
                const inputElement = document.createElement('input');
                inputElement.type = 'hidden';
                inputElement.name = 'answers';
                inputElement.value = JSON.stringify(answers);
                
                const oldInput = form.querySelector('input[name="answers"]');
                if (oldInput) {
                    oldInput.remove();
                }
                form.appendChild(inputElement);
            });
        });
    }

    // Initialisation en fonction du type d'exercice
    switch (exerciseType) {
        case 'qcm':
            handleQCM();
            break;
        case 'word_search':
            handleWordSearch();
            break;
        case 'drag_and_drop':
            handleDragAndDrop();
            break;
        case 'fill_in_blanks':
            handleFillInBlanks();
            break;
    }
});
</script>
{% endblock %}
