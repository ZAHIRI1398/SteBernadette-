{% set content = exercise.get_content() %}
{% if content and content.words and content.grid %}
    <div class="word-search-container">
        <form id="exerciseForm" method="POST" action="{{ url_for('submit_exercise', exercise_id=exercise.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="exercise_type" value="word_search">
            <input type="hidden" id="foundWords" name="found_words" value="">
            
            <div class="row">
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-body">
                            <div class="word-search-grid">
                                {% for row_index in range(content.grid|length) %}
                                    <div class="grid-row">
                                        {% for cell in content.grid[row_index] %}
                                            <div class="grid-cell" 
                                                 data-row="{{ row_index }}" 
                                                 data-col="{{ loop.index0 }}">
                                                {{ cell }}
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Mots à trouver</h5>
                        </div>
                        <div class="card-body">
                            <ul class="word-list list-group list-group-flush">
                                {% for word in content.words %}
                                    <li class="list-group-item" data-word="{{ word.strip() }}">{{ word }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> Valider mes réponses
                </button>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let selectedCells = [];
            let foundWords = new Set();
            let startCell = null;
            let direction = null;
            const grid = document.querySelector('.word-search-grid');
            const wordList = document.querySelector('.word-list');
            const foundWordsInput = document.getElementById('foundWords');
            const form = document.getElementById('exerciseForm');

            // Fonction pour normaliser un mot (enlever les espaces et mettre en minuscules)
            function normalizeWord(word) {
                return word.toLowerCase().trim();
            }

            function updateFoundWordsInput() {
                console.log('Updating found words input:', Array.from(foundWords));
                foundWordsInput.value = Array.from(foundWords).join(',');
            }

            function checkWord(selectedWord) {
                selectedWord = normalizeWord(selectedWord);
                const wordItems = wordList.querySelectorAll('li');
                for (let item of wordItems) {
                    const targetWord = normalizeWord(item.dataset.word);
                    console.log('Checking word:', selectedWord, 'against:', targetWord);
                    if (targetWord === selectedWord && !item.classList.contains('found')) {
                        console.log('Word found:', selectedWord);
                        item.classList.add('found', 'bg-success', 'text-white');
                        foundWords.add(item.dataset.word.trim());  // Garder le mot original pour le serveur
                        updateFoundWordsInput();
                        return true;
                    }
                }
                return false;
            }

            function getDirection(cell1, cell2) {
                const row1 = parseInt(cell1.dataset.row);
                const col1 = parseInt(cell1.dataset.col);
                const row2 = parseInt(cell2.dataset.row);
                const col2 = parseInt(cell2.dataset.col);
                
                const rowDiff = row2 - row1;
                const colDiff = col2 - col1;
                
                if (rowDiff === 0 && colDiff !== 0) return 'horizontal';
                if (rowDiff !== 0 && colDiff === 0) return 'vertical';
                if (Math.abs(rowDiff) === Math.abs(colDiff)) return 'diagonal';
                return null;
            }

            function isValidNextCell(currentCell, nextCell, establishedDirection) {
                if (!currentCell || !nextCell) return false;
                
                const row1 = parseInt(currentCell.dataset.row);
                const col1 = parseInt(currentCell.dataset.col);
                const row2 = parseInt(nextCell.dataset.row);
                const col2 = parseInt(nextCell.dataset.col);
                
                const rowDiff = row2 - row1;
                const colDiff = col2 - col1;
                
                switch (establishedDirection) {
                    case 'horizontal':
                        return row2 === row1 && Math.abs(colDiff) === 1;
                    case 'vertical':
                        return col2 === col1 && Math.abs(rowDiff) === 1;
                    case 'diagonal':
                        return Math.abs(rowDiff) === 1 && Math.abs(colDiff) === 1;
                    default:
                        return false;
                }
            }

            let isSelecting = false;

            grid.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('grid-cell')) {
                    isSelecting = true;
                    startCell = e.target;
                    selectedCells = [startCell];
                    direction = null;
                    startCell.classList.add('selected');
                }
            });

            grid.addEventListener('mouseover', function(e) {
                if (!isSelecting || !e.target.classList.contains('grid-cell')) return;
                
                const currentCell = e.target;
                if (selectedCells.includes(currentCell)) return;
                
                if (selectedCells.length === 1) {
                    direction = getDirection(startCell, currentCell);
                    if (direction) {
                        selectedCells.push(currentCell);
                        currentCell.classList.add('selected');
                    }
                } else if (direction && isValidNextCell(selectedCells[selectedCells.length - 1], currentCell, direction)) {
                    selectedCells.push(currentCell);
                    currentCell.classList.add('selected');
                }
            });

            document.addEventListener('mouseup', function() {
                if (isSelecting) {
                    isSelecting = false;
                    direction = null;
                    startCell = null;
                    
                    const word = selectedCells.map(cell => cell.textContent.trim()).join('');
                    console.log('Selected word:', word);
                    const wordReverse = word.split('').reverse().join('');
                    console.log('Reverse word:', wordReverse);
                    
                    if (!checkWord(word)) {
                        checkWord(wordReverse);
                    }
                    
                    selectedCells.forEach(cell => cell.classList.remove('selected'));
                    selectedCells = [];
                }
            });

            form.addEventListener('submit', function(e) {
                console.log('Form submission. Found words:', Array.from(foundWords));
                
                if (foundWords.size === 0) {
                    e.preventDefault();
                    alert('Vous devez trouver au moins un mot avant de valider !');
                    return;
                }
                
                const requiredWords = Array.from(wordList.querySelectorAll('li')).map(li => normalizeWord(li.dataset.word));
                console.log('Required words:', requiredWords);
                const foundWordsNormalized = Array.from(foundWords).map(normalizeWord);
                const missingWords = requiredWords.filter(word => !foundWordsNormalized.includes(word));
                console.log('Missing words:', missingWords);
                
                if (missingWords.length > 0) {
                    if (!confirm('Il vous reste encore des mots à trouver. Voulez-vous vraiment valider maintenant ?')) {
                        e.preventDefault();
                    }
                }
            });
        });
    </script>

    <style>
        .word-search-grid {
            display: grid;
            gap: 2px;
            width: fit-content;
            margin: 0 auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }

        .grid-row {
            display: flex;
            gap: 2px;
        }

        .grid-cell {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1.2em;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
        }

        .grid-cell.selected {
            background-color: #007bff;
            color: white;
            transform: scale(1.1);
            z-index: 1;
        }

        .word-list .list-group-item {
            cursor: default;
            transition: all 0.3s ease;
        }

        .word-list .list-group-item.found {
            text-decoration: line-through;
        }
    </style>
{% else %}
    <div class="alert alert-warning">
        {% if not content.words %}
            Cet exercice n'a pas encore de mots définis.
        {% elif not content.grid %}
            La grille n'a pas encore été générée. Veuillez éditer l'exercice pour générer la grille.
        {% endif %}
    </div>
{% endif %}
