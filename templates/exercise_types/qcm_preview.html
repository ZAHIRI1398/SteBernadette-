{% set content = exercise.get_content() %}
{% if content and content.questions %}
    <form id="exerciseForm" method="POST" action="{{ url_for('submit_exercise', exercise_id=exercise.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="qcm-container">
            {% for question in content.questions %}
                {% set question_index = loop.index0 %}
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Question {{ loop.index }}</h5>
                        <p class="question-text">{{ question }}</p>
                        
                        <div class="options-list">
                            {% for option in content.options[question_index] %}
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" 
                                           name="answer_{{ question_index }}" 
                                           id="option_{{ question_index }}_{{ loop.index0 }}"
                                           value="{{ option }}"
                                           required>
                                    <label class="form-check-label" for="option_{{ question_index }}_{{ loop.index0 }}">
                                        {{ option }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}

            <div class="text-center mt-4 mb-4">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    Valider mes réponses
                </button>
            </div>
        </div>
    </form>

    <style>
    .qcm-container {
        max-width: 800px;
        margin: 0 auto;
    }

    .question-text {
        font-size: 1.1rem;
        margin-bottom: 1.5rem;
    }

    .options-list {
        padding-left: 1rem;
    }

    .form-check {
        margin-bottom: 1rem;
    }

    .form-check-input {
        cursor: pointer;
    }

    .form-check-label {
        cursor: pointer;
        padding-left: 0.5rem;
    }

    .btn-primary {
        padding: 0.75rem 2rem;
    }
    </style>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('exerciseForm');
        const radioGroups = document.querySelectorAll('.options-list');
        const submitBtn = document.getElementById('submitBtn');

        // Fonction pour vérifier si toutes les questions ont une réponse
        function checkAllAnswered() {
            let allAnswered = true;
            radioGroups.forEach(group => {
                const radios = group.querySelectorAll('input[type="radio"]');
                const isAnswered = Array.from(radios).some(radio => radio.checked);
                if (!isAnswered) {
                    allAnswered = false;
                }
            });
            return allAnswered;
        }

        // Mettre à jour l'état du bouton
        function updateSubmitButton() {
            const allAnswered = checkAllAnswered();
            submitBtn.disabled = !allAnswered;
            if (allAnswered) {
                submitBtn.classList.remove('btn-secondary');
                submitBtn.classList.add('btn-primary');
            } else {
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-secondary');
            }
        }

        // Écouter les changements de réponses
        radioGroups.forEach(group => {
            group.addEventListener('change', function() {
                updateSubmitButton();
            });
        });

        // Vérifier avant la soumission
        form.addEventListener('submit', function(e) {
            if (!checkAllAnswered()) {
                e.preventDefault();
                alert('Veuillez répondre à toutes les questions avant de valider.');
            } else {
                // Préparer les réponses pour l'envoi
                const answers = {};
                radioGroups.forEach((group, index) => {
                    const checkedRadio = group.querySelector('input[type="radio"]:checked');
                    if (checkedRadio) {
                        answers[index] = checkedRadio.value;
                    }
                });
                
                // Créer un champ caché pour les réponses
                let answersInput = form.querySelector('input[name="answers"]');
                if (!answersInput) {
                    answersInput = document.createElement('input');
                    answersInput.type = 'hidden';
                    answersInput.name = 'answers';
                    form.appendChild(answersInput);
                }
                answersInput.value = JSON.stringify(answers);
            }
        });

        // Initialiser l'état du bouton
        updateSubmitButton();
    });
    </script>
{% else %}
    <div class="alert alert-warning">
        Cet exercice n'a pas encore de contenu défini.
    </div>
{% endif %}
