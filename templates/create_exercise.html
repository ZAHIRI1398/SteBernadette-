{% extends "base.html" %}

{% block title %}Créer un exercice{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Créer un nouvel exercice</h2>
    
    <form method="POST" action="{{ url_for('create_exercise') }}" enctype="multipart/form-data" id="exerciseForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        {{ form.csrf_token if form }}
        <div class="mb-3">
            <label for="title" class="form-label">Titre</label>
            <input type="text" class="form-control" id="title" name="title" required>
        </div>
        
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>
        
        <div class="mb-3">
            <label for="exercise_type" class="form-label">Type d'exercice</label>
            <select class="form-select" id="exercise_type" name="exercise_type" required>
                <option value="">Choisir un type d'exercice</option>
                {% for type_code, type_name in exercise_types %}
                <option value="{{ type_code }}">{{ type_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="max_attempts" class="form-label">Nombre maximum de tentatives</label>
            <input type="number" class="form-control" id="max_attempts" name="max_attempts" value="3" min="1" required>
            <small class="form-text text-muted">Nombre de fois qu'un élève peut essayer cet exercice</small>
        </div>

        <!-- Section QCM -->
        <div id="qcm_section" class="exercise-type-section" style="display: none;">
            <div class="questions-container">
                <div class="question-block mb-4" data-question-index="0">
                    <h4>Question 1</h4>
                    <div class="mb-3">
                        <label class="form-label">Question</label>
                        <input type="text" class="form-control" name="questions[0][question]" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Options</label>
                        <div class="options-container">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" name="questions[0][options][]" required>
                                <div class="input-group-text">
                                    <input type="radio" name="questions[0][correct]" value="0" required>
                                </div>
                                <button type="button" class="btn btn-danger remove-option">×</button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm add-option">
                            <i class="fas fa-plus"></i> Ajouter une option
                        </button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary add-question">
                <i class="fas fa-plus"></i> Ajouter une question
            </button>
        </div>

        <!-- Section Mots mêlés -->
        <div id="word_search_section" class="exercise-type-section" style="display: none;">
            <div class="mb-3">
                <label class="form-label">Mots à trouver</label>
                <textarea class="form-control" name="words" rows="3" placeholder="Entrez les mots séparés par des virgules" required></textarea>
                <small class="form-text text-muted">Séparez les mots par des virgules (exemple : chat, chien, oiseau)</small>
            </div>
        </div>

        <!-- Section Association de paires -->
        <div id="pairs_section" class="exercise-type-section" style="display: none;">
            <div class="pairs-container">
                <div class="pair-block mb-3">
                    <div class="row">
                        <div class="col">
                            <label class="form-label">Élément 1</label>
                            <input type="text" class="form-control" name="pairs[0][first]" required>
                        </div>
                        <div class="col">
                            <label class="form-label">Élément 2</label>
                            <input type="text" class="form-control" name="pairs[0][second]" required>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary add-pair">
                <i class="fas fa-plus"></i> Ajouter une paire
            </button>
        </div>

        <!-- Section Texte à trous -->
        <div id="fill_in_blanks_section" class="exercise-type-section" style="display: none;">
            <div class="mb-3">
                <label class="form-label">Texte avec trous</label>
                <textarea class="form-control" name="text" rows="5" placeholder="Entrez le texte en utilisant [...] pour les trous. Exemple : Le [...] est un animal." required></textarea>
                <small class="form-text text-muted">Utilisez [...] pour marquer les trous dans le texte</small>
            </div>
            <div class="mb-3">
                <label class="form-label">Réponses</label>
                <textarea class="form-control" name="answers" rows="3" placeholder="Entrez les réponses dans l'ordre, séparées par des virgules" required></textarea>
                <small class="form-text text-muted">Les réponses doivent être dans le même ordre que les trous</small>
            </div>
        </div>

        <!-- Section Dépôt de fichier -->
        <div id="file_section" class="exercise-type-section" style="display: none;">
            <div class="mb-3">
                <label class="form-label">Instructions</label>
                <textarea class="form-control" name="instructions" rows="3" placeholder="Entrez les instructions pour le dépôt de fichier" required></textarea>
            </div>
        </div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Créer l'exercice
            </button>
            <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                <i class="fas fa-times"></i> Annuler
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const exerciseForm = document.getElementById('exerciseForm');
    const exerciseType = document.getElementById('exercise_type');
    
    // Fonction pour afficher/masquer les sections
    function toggleSections() {
        const selectedType = exerciseType.value;
        document.querySelectorAll('.exercise-type-section').forEach(section => {
            section.style.display = 'none';
            // Désactiver les champs required
            section.querySelectorAll('[required]').forEach(field => {
                field.removeAttribute('required');
            });
        });
        
        if (selectedType) {
            const selectedSection = document.getElementById(selectedType + '_section');
            if (selectedSection) {
                selectedSection.style.display = 'block';
                // Réactiver les champs required
                selectedSection.querySelectorAll('[data-required]').forEach(field => {
                    field.setAttribute('required', '');
                });
            }
        }
    }
    
    // Marquer les champs initialement requis
    document.querySelectorAll('.exercise-type-section [required]').forEach(field => {
        field.setAttribute('data-required', '');
    });
    
    // Écouter les changements de type d'exercice
    exerciseType.addEventListener('change', toggleSections);
    
    // Initialiser l'affichage
    toggleSections();
    
    // Validation du formulaire
    exerciseForm.addEventListener('submit', function(e) {
        const selectedType = exerciseType.value;
        if (!selectedType) {
            e.preventDefault();
            alert('Veuillez sélectionner un type d\'exercice');
            return;
        }
        
        const selectedSection = document.getElementById(selectedType + '_section');
        if (selectedSection) {
            const requiredFields = selectedSection.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('is-invalid');
                } else {
                    field.classList.remove('is-invalid');
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Veuillez remplir tous les champs obligatoires');
            }
        }
    });
});
</script>
{% endblock %}
